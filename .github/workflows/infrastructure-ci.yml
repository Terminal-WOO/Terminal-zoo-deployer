name: Infrastructure CI

on:
  pull_request:
    paths:
      - 'k8s/**'
      - 'infrastructure/**'
      - '.github/workflows/infrastructure-ci.yml'
  push:
    branches:
      - main
    paths:
      - 'k8s/**'
      - 'infrastructure/**'
  workflow_dispatch:

jobs:
  validate-manifests:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Install kubeval
        run: |
          wget -q https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin/

      - name: Validate manifests with kubeval
        run: |
          kubeval k8s/*.yaml --strict || true
          # Continue even if kubeval fails (some manifests might not be valid YAML for kubeval)

      - name: Validate with kubectl dry-run
        run: |
          bash infrastructure/tests/validate-manifests.sh

  lint-manifests:
    name: Lint Kubernetes Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kube-score
        run: |
          wget -q https://github.com/zegl/kube-score/releases/download/v1.17.0/kube-score_1.17.0_linux_amd64.tar.gz
          tar xf kube-score_1.17.0_linux_amd64.tar.gz
          sudo mv kube-score /usr/local/bin/

      - name: Score manifests
        run: |
          kube-score score k8s/*.yaml || true
          # Continue even if scoring finds issues (for now)

  check-kustomization:
    name: Check Kustomization
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Install kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Build kustomization
        run: |
          cd k8s
          kustomize build . > /dev/null

  infrastructure-summary:
    name: Infrastructure CI Summary
    runs-on: ubuntu-latest
    needs: [validate-manifests, lint-manifests, check-kustomization]
    if: always()
    steps:
      - name: CI Summary
        run: |
          echo "## Infrastructure CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Completed Jobs:" >> $GITHUB_STEP_SUMMARY
          echo "- Manifest Validation: ${{ needs.validate-manifests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Manifest Linting: ${{ needs.lint-manifests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Kustomization Check: ${{ needs.check-kustomization.result }}" >> $GITHUB_STEP_SUMMARY

