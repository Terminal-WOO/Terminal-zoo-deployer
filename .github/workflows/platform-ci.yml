name: Platform CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: rg.nl-ams.scw.cloud

jobs:
  # Code Quality Checks
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Check Go formatting
        run: |
          cd go
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "❌ Go code is not formatted. Run 'go fmt ./...'"
            gofmt -s -d .
            exit 1
          fi

  # Tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run frontend tests
        run: npm test

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Run backend tests
        run: |
          cd go
          go test ./... -v

  # Security Scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build frontend image for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: frontend:scan
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Scan frontend image
        run: |
          docker scan frontend:scan --severity high --file scan-report-frontend.json || true
          if grep -q "CRITICAL" scan-report-frontend.json 2>/dev/null; then
            echo "❌ Critical vulnerabilities found in frontend image!"
            exit 1
          fi

      - name: Build backend image for scanning
        uses: docker/build-push-action@v5
        with:
          context: ./go
          file: ./go/Dockerfile.multi-stage
          push: false
          tags: backend:scan
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Scan backend image
        run: |
          docker scan backend:scan --severity high --file scan-report-backend.json || true
          if grep -q "CRITICAL" scan-report-backend.json 2>/dev/null; then
            echo "❌ Critical vulnerabilities found in backend image!"
            exit 1
          fi

      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate || true
          npm audit --json > npm-audit-report.json || true

      - name: Check Go dependencies
        run: |
          cd go
          go list -u -m all > go-dependencies.txt || true

  # Domain Boundaries Check
  domain-boundaries:
    name: Check Domain Boundaries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check domain boundaries
        run: |
          bash scripts/check-domain-boundaries.sh

  # Code Quality Metrics
  code-quality:
    name: Code Quality Metrics
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Install gocyclo
        run: go install github.com/fzipp/gocyclo/cmd/gocyclo@latest

      - name: Check cyclomatic complexity
        run: |
          cd go
          gocyclo -over 10 . || echo "⚠️  Some functions have complexity > 10"

      - name: Run go vet
        run: |
          cd go
          go vet ./...

      - name: Run go mod verify
        run: |
          cd go
          go mod verify

  # Build Verification
  build-verify:
    name: Verify Builds
    runs-on: ubuntu-latest
    needs: [lint, test, security-scan]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build frontend (no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          platforms: linux/amd64
          tags: frontend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build backend (no push)
        uses: docker/build-push-action@v5
        with:
          context: ./go
          file: ./go/Dockerfile.multi-stage
          push: false
          platforms: linux/amd64
          tags: backend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify image sizes
        run: |
          FRONTEND_SIZE=$(docker images frontend:test --format "{{.Size}}" | sed 's/[^0-9.]//g')
          BACKEND_SIZE=$(docker images backend:test --format "{{.Size}}" | sed 's/[^0-9.]//g')
          echo "Frontend image size: ${FRONTEND_SIZE}"
          echo "Backend image size: ${BACKEND_SIZE}"
          # Add size checks if needed

  # Fitness Functions Check
  fitness-functions:
    name: Architectural Fitness Functions
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run fitness function checks
        run: |
          echo "Running architectural fitness function checks..."
          # This would integrate with monitoring/metrics
          # For now, we run basic checks
          bash scripts/check-domain-boundaries.sh
          echo "✅ Fitness function checks passed"

  # Summary
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, test, security-scan, domain-boundaries, code-quality, build-verify]
    if: always()
    steps:
      - name: CI Summary
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All checks completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Completed Jobs:" >> $GITHUB_STEP_SUMMARY
          echo "- Lint: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Domain Boundaries: ${{ needs.domain-boundaries.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build Verify: ${{ needs.build-verify.result }}" >> $GITHUB_STEP_SUMMARY

